---
title: "Generic NMA for Dichotomous Outcomes"
author: "Tasnim Hamza"
date: "`r Sys.Date()`"
output: pdf_document 
bibliography: references.bib 
vignette: >
  %\VignetteIndexEntry{crosnma}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup}
library(crosnma)
```
# The underlying assumptions of parameters
We summarize the different assumptions that can be set for the parameters in the model by the following table. 

| Parameters 	| Assumptions| R-code in `crosnma.model()`|  	
|:-------------------|:-----------|:------|
|relative treatment effect ($\delta_{jk}$)| Random-effect model: $\delta_{jk} \sim N(d_{Ak}-d_{Ab}, \tau_\delta^2)$| `trt.effect='random'` |
|   	|Common-effect model: $\delta_{jk}=d_{Ak}-d_{Ab}$| `trt.effect='common'`|
|Covariate effect $\beta_{0, j}$ | Independent effect model: $\beta_{0, j} \sim N(0, 10^2)$| `reg0.effect='independent'` |
|   	|Random-effect model: $\beta_{0,j} \sim N(B_0, \tau_{\beta_0})$| `reg0.effect='random'`|
|Within-study covariate-treatment interaction ($\beta_{1, jk}^W$)| Random-effect model: $\beta_{1, jk}^W \sim N(B_{1, Ak}^W-B_{1, Ab}^W, \tau_{\beta_1^W})$| `regw.effect='random'` |
|   	|Common-effect model: $\beta_{1,jk}^W = B_{1, Ak}^W-B_{1, Ab}^W$| `regw.effect='common'`|
|Between-study covariate-treatment interaction ($\beta_{1, jk}^B$)| Random-effect model: $\beta_{1,jk}^B \sim N(B_{1, Ak}^B-B_{1, Ab}^B, \tau_{\beta_1^B})$| `regb.effect='random'` |
|   	|Common-effect model: $\beta_{1,jk}^B = B_{1, Ak}^B-B_{1, Ab}^B$| `regb.effect='common'`|
|Bias effect ($\gamma_{j}$)| Random-effect model: $\gamma_{j} \sim N(\Gamma, \tau_{\gamma})$| `bias.effect='random'` |
|   	|Common-effect model: $\gamma_{j} = \Gamma$| `bias.effect='common'`|

Here, the participant $i$ in study $j$ has been assigned to treatment $k$. The index $b$ refers to the study-specific baseline treatment. The term $\tau_*$ refers to the heterogeneity between studies with a subscript ($_*$) to indicate the corresponding parameter. More details can be found in Section 2 in [@hamza_2021].

# Data
The `crosnma` package involves  two datasets;individual participant data `prt.data` and study-level data `std.data`.

The data result in a network that consists of 4 treatments and has been studied in 6 different studies.Five of them are randomized-controlled trials (RCT) and the remaining one is non-randomized studies (NRS). The data of the NRS study is available on the participant-level. While the data of the 3 RCTs are provided on the participant-level and 2 RCTs are available only on the study-level.

```{r}
head(prt.data)
head(std.data)
```

# Explore the network
## Check network connectivity
The network should be checked for its connectivity before running the analysis. This is a vital step as the model will run even if the network is not connected. In this case, it provides the wrong estimates which are our pre-specified prior information.

### Network plot
```{r}
# to be added later
```

## Network characteristics
```{r}
# to be added
```

# The generic NMA/NMR models to combine RCT and NRS
Two steps to run the NMA/NMR model. The first step is to create JAGS model using `crosnma.model()` which involves JAGS code and the reformatted data. In the second step, the output of that function will be used in `crosnma.run()` to run the analysis through JAGS [@plummer_jags]. 

In the rest of the document we illustrate the four different methods that can be used to combine the evidence from RCT and NRS. For each method, we set up the model, run the analysis and present the results. 

## Na√Øve method
This is the simplest method where the evidence from the two designs are combined naively without acknowledging the differences between them, see Section 2.2.1 in [@hamza_2021].
### Set up JAGS model
We start by indicating the names of the datasets on participant- (`prt.data`) and study-level (`std.data`). Then, the name of the variables on each dataset need to be given respectively in `prt.data` and `std.data`.  Next, the `reference` treatment need to be assigned ( drug A). By choosing `trt.effect=random`, we assign a normal distribution to each relative treatment effect across studies, see the table in Section 1. Finally, the different designs; RCT and NRS are combined naively; `method.bias = 'naive'`.

```{r}
# jags model: code+data
 mod1 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   trt.effect='random',
                   reference='A',
                   method.bias = 'naive'
                    )
```

### Run JAGS
Next, we fit the NMA model using `crosnma.run()`which requires the number of adaptations, iterations, thinning and chains to be set.
```{r}
# run jags
jagsfit1 <- crosnma.run(model=mod1,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

### Output
#### Table of estimates
We summarize the estimated parameters by the following table. 
```{r}
knitr::kable(summary(jagsfit1,expo=T))
```

#### Plot of estimates
```{r}
# to be added
```

## Using NRS as a prior
In this part, we run a generic NMR model using `sex` and `age` as covariates.  To combine both designs, we use NRS evidence as a prior information for the RCT likelihood, see Section 2.2.2 in [@hamza_2021]. 

### Set up JAGS model
In this case, three additional arguments are needed; the first one is to run network meta-regression and the rest are to control combining RCT and NRS.

1. We set a list of 2 covariates in prt.data and std.data, respectively, `covariate=list(c('age','sex'),c('age','sex'))`.
1.  We indicate using NRS as a prior` method.bias='prior'`.  
1. This means that a NMA is initially run with only NRS data. This requires the following MCMC settings: the number of adaptations, iterations, burn-ins, thinning and chains. 

In this method, the prior of the RCT basic parameters is set to a normal distribution that is either a minimally informative prior `d~dnorm(0, 1e-4)` (for those we don't have NRS information) or the NRS mean and variance (for those which we observe the NRS evidence).  The mean can be shifted by `mean.shift` to reflect the potential bias from NRS or the variance can be inflated by `var.infl` to control the influence of NRS on the estimation from RCTs. 
```{r}
# jags model: code+data
mod2 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ---------- 
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ---------- 
                   method.bias='prior',
                   run.nrs=list(n.adapt = 10,
                                n.iter=10,
                                n.burnin = 5,
                                thin=1,
                                n.chains=1))
```

### Run JAGS
The MCMC is run under the same set up as in the naive model (Section 4.1.2).
```{r}
# run jags
jagsfit2 <- crosnma.run(model=mod2,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

### Output
#### Table of estimates
```{r}
knitr::kable(summary(jagsfit2))
```

#### Plot of estimates
```{r}
#plot(jagsfit1)
```


## Adjusting for the study-specific bias - method 1
In this part, we run again a generic NMR model using `sex` and `age` as covariates. But now, the overall relative treatment effects are estimated from both NRS and RCT with adjustment to study-specific bias following the method introduced by [@dias_2010], see also Section 2.2.3 in [@hamza_2021].

### Set up JAGS model
Additionally, we provide the name of the bias variable `bias=c('bias','bias')` in `prt.data` and `std.data`, respectively. The effect of bias is assumed to be additive to the treatment effect so `bias.type='add'`. The bias effect is set to be equal across studies `bias.effect='common'`. It is optional to give a list of the different priors to control the estimates of the corresponding parameters. Here, we set a uniform distribution to the common heterogeneity of the treatment effect across studies, `tau.trt='dunif(0,3)'`. We also set beta distribution (${Beta(a,b)}$) as priors for the probability of bias on each study. We assumed these four categories: high bias RCT `pi.high.rct='dbeta(5,1)'`, low bias RCT `pi.low.rct='dbeta(1,20)'`,high bias NRS `pi.high.nrs='dbeta(30,1)'` and low bias NRS `pi.low.nrs='dbeta(1,2)'`.  The ratio ${a/b}$ controls the skewness of the beta distribution.  When the ratio goes further beyond 1, the mean becomes located closer to 1 and the study needs 'major' bias adjustment and vice versa. 
```{r}
# jags model: code+data
mod3 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ---------- 
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ---------- 
                   method.bias='adjust1',
                   bias=c('bias','bias'), 
                   bias.type='add',
                   bias.effect='common',
                   #---------- assign a prior ---------- 
                   prior=list(tau.trt='dunif(0,3)',
                              pi.high.rct='dbeta(5,1)',
                              pi.low.rct='dbeta(1,20)',
                              pi.high.nrs='dbeta(30,1)',
                              pi.low.nrs='dbeta(1,2)'
                                  )
                  )
```

### Run JAGS

```{r}
# run jags
jagsfit3 <- crosnma.run(model=mod3,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

### Output
#### Table of estimates
```{r}
knitr::kable(summary(jagsfit3))
```

#### Plot of estimates
```{r}
# to be added
```


## Adjusting for the study-specific bias - method 2

### Set up JAGS model
The arguments for `method.bias='adjust2'` are similar to the ones that were used above for `method.bias='adjust1'`. However, there are two main differences between them. First, in `'adjust2'`, the relative treatment effects are modeled with a bi-modal normal distribution instead of a univariate normal distribution as in  `'adjust1'` method. Second, we can use a logistic model with a year as a covariate `bias.covariate = c('year','year')` to estimate the probability of bias in `'adjust2'`. In `'adjust1'`, instead we assume  a (${Beta(a,b)}$) to estimate the probability of bias. More details about this method can be found in [@verde_2020] and in Section 2.2.2 in [@hamza_2021].

```{r}
# jags model: code+data
mod4 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ----------
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ----------
                   method.bias='adjust1',
                   bias=c('bias','bias'),
                   bias.type='add',
                   bias.effect='common',
                   bias.covariate = c('year','year'),#
                   #---------- assign a prior ----------
                   prior=list(tau.trt='dunif(0,3)',
                              pi.high.rct='dbeta(5,1)',
                              pi.low.rct='dbeta(1,20)',
                              pi.high.nrs='dbeta(30,1)',
                              pi.low.nrs='dbeta(1,2)'
                   )
)
```

### Run JAGS 

```{r}
# run jags
jagsfit4 <- crosnma.run(model=mod4,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

### Output
#### Table of estimates
```{r}
knitr::kable(summary(jagsfit4))
```

#### Plot of estimates
```{r}
# to be added
```


# References


