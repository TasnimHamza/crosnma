---
title: "Cross-design and cross-data format synthesis using Network Meta-Analysis (crosnma)"
author: "Tasnim Hamza"
date: "`r Sys.Date()`"
output: 
  html_vignette:
   toc: true
   number_sections: true
bibliography: references.bib 
vignette: >
  %\VignetteIndexEntry{crosnma}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(crosnma)
```
# Introduction 
Network meta-analysis (NMA) is a common tool to compare multiple interventions simultaneously. This requires synthesize the available evidence that might come as different study design or data format. As different study designs, the evidence can be obtained from non-randomized studies (NRS) or randomized controlled trials (RCT). RCT evidence quality is considered the highest and at a lower risk of bias, however, the restricted settings when RCTs are conducted limit the generalizability of their results. Therefore, combining RCT and NRS evidence in NMA may help overcome some of the limitations. Such evidence can be accessible in different data formats as individual participant data (IPD) or aggregate data (AD). We establish a cross-design and cross-data format package (`crosnma`) to utilize all available and relevant evidence.

We describe the R package `crosnma` in a worked example about relapsing remitting multiple sclerosis (RRMS). The primary outcome is the occurrence of relapses in two years (binary outcome, 0/1). In the analysis, the outcome will be expressed as odds ratio (OR). The aim is to compare the efficacy of four treatments. Data is available from 6 different studies in different formats and different designs. The studies are either available as study-level data `std.data` (2 studies) or as individual participant data `prt.data` (four studies). Three of the `prt.data` are RCTs and one comes from an observational study (NRS). The two `std.data` are RCTs.

The `prt.data` contains 2950 rows, each refers to a participant in the study. We display the first few rows of the data set:

```{r}
head(prt.data)
```

For each participant, we have information for the occurrence of the relapses (0=no, 1=yes) `outcome`, the treatment label `trt`, the age (in years) `age` and  sex (0 = Female, 1 = Male) `sex` of the participant. The other following columns are set on study-level (it is repeated for each participant of the study): the study id `study`, the design of the study ( needs to be either rct or nrs) `design`, the risk of bias on each study (set as a low, high or unclear) `bias` and the year of publication `year`.

We display the full data that is available on study-level:
```{r}
head(std.data)
```
For all studies, we provide the following information on each arm level: the total number of participants `n` and the number of those who relapsed `outcome`, the treatment label `trt`. At study-level, we have the study id `study`, the design of the study `design`, the mean age `age`, the percentage of males `sex`, the risk of bias on the study `bias` and the year of publication `year`.

# The synthesis model of individual participant data (IPD) and aggregate data (AD)

We introduce the model to synthesis individual participant data (IPD) and aggregate data (AD). Each data format could come from randomized clinical trials (RCT) or non-randomized studies (NRS). These two designs could be combined in one of four different methods. We describe the four synthesis models for network meta-regression. However, we can run the network meta-analysis by decline the covariates terms from the models. Let's begin with describing the notations that will be used in the description of the models. 

| Notation 	| Description| Argument in `crosnma.model()`| 
|:-------------------|:-----------|:------|
|$i=1, ..., np_j$ | participant id|  |
|$j=1, ..., ns$ | study id|  |
|$k=1, ..., K$ | treatment index|  |
|$ns_{IPD}, ns_{AD}, ns_{RCT}, ns_{NRS}$| number of studies with index denote the design or format of the study|  |
|$y_{ijk}$ | binary outcome (0/1)| `outcome` |
|$p_{ijk}$ | probability of the event to occur| |
|$r_{jk}$ | the number of events per arm| `outcome` |
|$n_{jk}$ | the sample size per arm| `n` |
|$b$ |the study-specific reference|*|
|$u_{j}$ | The treatment effect of the study-specific reference | |
|$\delta_{jk}$|log(OR) of treatment k relative to $b$||
|$x_{ijk}$|the covariate|`covariate`|
|$\bar{x}_{j}$|the mean covariate for study $j$||
|$d_{Ak}$| the basic parameters, $d_{AA}=0$ (A is the reference in the network)|use `reference` to assign the reference treatment $A$|
|$z_j$| study characteristics to estimate the bias probability $\pi_j$| `bias.covariate` |
|$w_j$| inflation factor of variance for the NRS estimates | the element `var.infl` in `run.nrs`|
|$\vartheta_j$| mean shift of the NRS estimates | the element `mean.shift` in `run.nrs`|
*it is assigned automatically to the reference in the network ($A$), if it is available on the study. If not, it is assigned automatically to the first alphabetically treatment on the study

## Naive synthesis

We synthesis the evidence from RCT and NRS without acknowledging the differences between them. For both of them, we model the IPD data and the AD data as the following.

**model IPD only**

$$
y_{ijk} \sim Bernoulli(p_{ijk})
$$
\begin{equation}
  logit(p_{ijk}) =
    \begin{cases}
      u_j +\beta_{1,j} x_{ijk} & \text{if $k=b$}\\
      u_j +\delta_{jk} + (\beta_{1,j}+\beta^w_{2,jk}) x_{ijk}+
 (\beta^B_{2,jk}-\beta^w_{2,jk}) \bar{x}_{.j} & \text{if $k≠b$}
    \end{cases}       
\end{equation}

**model AD only**
$$
r_{jk} \sim Binomial(p_{jk},n_{jk})
$$
\begin{equation}
  logit(p_{jk}) =
    \begin{cases}
      u_j  & \text{if $k=b$}\\
      u_j +\delta_{jk} +\beta^B_{2,jk} \bar{x}_{j} & \text{if $k≠b$}
    \end{cases}       
\end{equation}

## Using NRS as a prior

We run the model in Section 2.1 two consequent times. First we estimate the relative treatment effects only using the NRS (use `run.nrs` in `crosnma.model()` to control the process). Second, we use the NRS estimates ($\hat{d}^{NRS}_{Ak},\hat{V}^{NRS}_{Ak}$) as a prior information for the basic parameters of RCT data, $d_{Ak} \sim N(\hat{d}^{NRS}_{Ak},\hat{V}^{NRS}_{Ak})$. To control the NRS influence in the RCT estimates, we can either inflate the NRS variance by $w_j$ (the inflated variance is $\hat{V}^{NRS}_{Ak}/w_j$) or shift the NRS means by $\vartheta$.

## RoB-adjusted model 1

We incorporate the risk of bias (RoB) into the IPD and the AD models by adding the bias term $\gamma_j R_j$ to each.

**model IPD only**

$$
y_{ijk} \sim Bernoulli(p_{ijk})
$$
\begin{equation}
  logit(p_{ijk}) =
    \begin{cases}
      u_j +\beta_{1,j} x_{ijk} & \text{if $k=b$}\\
      u_j +\delta_{jk} + (\beta_{1,j}+\beta^w_{2,jk}) x_{ijk}+
 (\beta^B_{2,jk}-\beta^w_{2,jk}) \bar{x}_{.j}+\gamma_j R_j & \text{if $k≠b$}
    \end{cases}       
\end{equation}

**model AD only**
$$
r_{jk} \sim Binomial(p_{jk},n_{jk})
$$
\begin{equation}
  logit(p_{jk}) =
    \begin{cases}
      u_j  & \text{if $k=b$}\\
      u_j +\delta_{jk} +
 \beta^B_{2,jk} \bar{x}_{j}+\gamma_j R_j & \text{if $k≠b$}
    \end{cases}       
\end{equation}

The bias indicator

$$
R_j \sim Bernoulli(\pi_j)
$$


## RoB-adjusted model 2

Another way to incorporate the study RoB is by adding the bias adjusted relative treatment effect $\theta_{jk}$ instead of the unadjusted one $\delta_{jk}$. Then to model $\theta_{jk}$ by a bi-modal normal distribution as in Table 2 below. We estimate the bias probability $\pi_j$ by either assigning a beta distribution or by using a study characteristics $z_j$ through a logistic transformation. 

**model IPD only**

$$
y_{ijk} \sim Bernoulli(p_{ijk})
$$
\begin{equation}
  logit(p_{ijk}) =
    \begin{cases}
      u_j +\beta_{1,j} x_{ijk} & \text{if $k=b$}\\
      u_j +\theta_{jk} + (\beta_{1,j}+\beta^w_{2,jk}) x_{ijk}+
 (\beta^B_{2,jk}-\beta^w_{2,jk}) \bar{x}_{j} & \text{if $k≠b$}
    \end{cases}       
\end{equation}

**model AD only**
$$
r_{jk} \sim Binomial(p_{jk},n_{jk})
$$
\begin{equation}
  logit(p_{jk}) =
    \begin{cases}
      u_j & \text{if $k=b$}\\
      u_j +\theta_{jk} +\beta^B_{2,jk} \bar{x}_{j} & \text{if $k≠b$}
    \end{cases}       
\end{equation}

**Combine IPD and AD**

The table below summarizes the different assumptions implemented in the package about combining the parameters in the model described the previous section. 

| Parameter 	| Assumptions| Argument in `crosnma.model()`|  	
|:----------------------|:-----------|:------|
|relative treatment effect ($\delta_{jk}$)| Random-effects: $\delta_{jk} \sim N(d_{Ak}-d_{Ab}, \tau_\delta^2)$| `trt.effect='random'` |
|   	|Common-effect: $\delta_{jk}=d_{Ak}-d_{Ab}$| `trt.effect='common'`|
|Covariate effect $\beta_{0, j}$ | Independent effects: $\beta_{0, j} \sim N(0, 10^2)$| `reg0.effect='independent'` |
|   	|Random-effects: $\beta_{0,j} \sim N(B_0, \tau_{\beta_0})$| `reg0.effect='random'`|
|Within-study covariate-treatment interaction ($\beta_{1, jk}^W$)| Random-effects: $\beta_{1, jk}^W \sim N(B_{1, Ak}^W-B_{1, Ab}^W, \tau_{\beta_1^W})$| `regw.effect='random'` |
|   	|Common-effect: $\beta_{1,jk}^W = B_{1, Ak}^W-B_{1, Ab}^W$| `regw.effect='common'`|
|Between-study covariate-treatment interaction ($\beta_{1, jk}^B$)| Random-effects: $\beta_{1,jk}^B \sim N(B_{1, Ak}^B-B_{1, Ab}^B, \tau_{\beta_1^B})$| `regb.effect='random'` |
|   	|Common-effect: $\beta_{1,jk}^B = B_{1, Ak}^B-B_{1, Ab}^B$| `regb.effect='common'`|
|bias-adjusted relative treatment effect ($\theta_{jk}$)| Random-effects: $\theta_{jk} \sim (1-\pi_j)N(d_{Ak}-d_{Ab}, \tau_\delta^2) + \pi_jN(d_{Ak}-d_{Ab}+\gamma_j, \tau_\delta^2+\tau_\gamma^2)$| `trt.effect='random'` |
|Bias effect ($\gamma_{j}$)| Random-effects: $\gamma_{j} \sim N(\Gamma, \tau_{\gamma})$| `bias.effect='random'` |
|   	|Common-effect: $\gamma_{j} = \Gamma$| `bias.effect='common'`|
|Bias probability ($\pi_j$)| $\pi_j \sim Beta(a,b)$|  |
|| $\pi_j = a+bz_j$|  |
# Explore the network
## Check network connectivity
The network should be checked for its connectivity before running the analysis. This is a vital step as the model will run even if the network is not connected.

**Network plot**
```{r}
# to be added later
```

## Network characteristics
```{r}
kable(ns.tab(prt.data,std.data)
      )

```

# The R implementation
There are two steps to run the NMA/NMR model. The first step is to create JAGS model using `crosnma.model()` which involves JAGS code and the reformatted data. In the second step, the output of that function will be used in `crosnma.run()` to run the analysis through JAGS [@plummer_jags]. 

## Naïve synthesis
This is the simplest method where the evidence from the two designs are combined naively without acknowledging the differences between them, see Section 2.2.1 in [@hamza_2021].
 
**Set up JAGS model**

We start by indicating the names of the datasets on participant- (`prt.data`) and study-level (`std.data`). Then, the name of the variables on each dataset need to be given respectively in `prt.data` and `std.data`.  Next, the `reference` treatment need to be assigned ( drug A). By choosing `trt.effect=random`, we assign a normal distribution to each relative treatment effect across studies, see the table in Section 2.1. Finally, the different designs; RCT and NRS are combined naively; `method.bias = 'naive'`.

```{r}
# jags model: code+data
 mod1 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   trt.effect='random',
                   reference='A',
                   method.bias = 'naive'
                    )
```

**Run JAGS**

Next, we fit the NMA model using `crosnma.run()`which requires the number of adaptations, iterations, thinning and chains to be set.

```{r}
# run jags
jagsfit1 <- crosnma.run(model=mod1,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

**Output**

*Table of estimates*

We summarize the estimated parameters by the following table. 

```{r}
knitr::kable(summary(jagsfit1,expo=T,))
```

*Plot of estimates*

```{r}
# to be added
```

## Using NRS as a prior
In this part, we run a generic NMR model using `sex` and `age` as covariates.  To combine both designs, we use NRS evidence as a prior information for the RCT likelihood, see Section 2.2.2 in [@hamza_2021]. 

**Set up JAGS model**

In this case, three additional arguments are needed; the first one is to run network meta-regression and the rest are to control combining RCT and NRS.

1. We set a list of 2 covariates in prt.data and std.data, respectively, `covariate=list(c('age','sex'),c('age','sex'))`.
1.  We indicate using NRS as a prior` method.bias='prior'`.  
1. This means that a NMA is initially run with only NRS data. This requires the following MCMC settings: the number of adaptations, iterations, burn-ins, thinning and chains. 

In this method, the prior of the RCT basic parameters is set to a normal distribution that is either a minimally informative prior `d~dnorm(0, 1e-4)` (for those we don't have NRS information) or the NRS mean and variance (for those which we observe the NRS evidence).  The mean can be shifted by `mean.shift` to reflect the potential bias from NRS or the variance can be inflated by `var.infl` to control the influence of NRS on the estimation from RCTs. 
```{r}
# jags model: code+data
mod2 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ---------- 
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ---------- 
                   method.bias='prior',
                   run.nrs=list(n.adapt = 10,
                                n.iter=10,
                                n.burnin = 5,
                                thin=1,
                                n.chains=1))
```

**Run JAGS**

The MCMC is run under the same set up as in the naive model.

```{r}
# run jags
jagsfit2 <- crosnma.run(model=mod2,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

**Output**

*Table of estimates*

```{r}
knitr::kable(summary(jagsfit2))
```

*Plot of estimates*

```{r}
#plot(jagsfit1)
```


## RoB-adjusted model 1
In this part, we run again the NMR model using `sex` and `age` as covariates. But now, the overall relative treatment effects are estimated from both NRS and RCT with adjustment to study-specific bias following the method introduced by [@dias_2010], see also Section 2.3 above.

**Set up JAGS model**

We provide the name of the bias variable `bias=c('bias','bias')` in `prt.data` and `std.data`, respectively. The effect of bias is assumed to be additive to the treatment effect so `bias.type='add'`. The bias effect is set to be equal across studies `bias.effect='common'`. It is optional to give a list of the different priors to control the estimates of the corresponding parameters. Here, we set a uniform distribution to the common heterogeneity of the treatment effect across studies, `tau.trt='dunif(0,3)'`. We also set beta distribution (${Beta(a,b)}$) as priors for the probability of bias on each study. We assumed these four categories: high bias RCT `pi.high.rct='dbeta(5,1)'`, low bias RCT `pi.low.rct='dbeta(1,20)'`,high bias NRS `pi.high.nrs='dbeta(30,1)'` and low bias NRS `pi.low.nrs='dbeta(1,2)'`.  The ratio ${a/b}$ controls the skewness of the beta distribution.  When the ratio goes further beyond 1, the mean becomes located closer to 1 and the study needs 'major' bias adjustment and vice versa.

```{r}
# jags model: code+data
mod3 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ---------- 
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ---------- 
                   method.bias='adjust1',
                   bias=c('bias','bias'), 
                   bias.type='add',
                   bias.effect='common',
                   #---------- assign a prior ---------- 
                   prior=list(tau.trt='dunif(0,3)',
                              pi.high.rct='dbeta(5,1)',
                              pi.low.rct='dbeta(1,20)',
                              pi.high.nrs='dbeta(30,1)',
                              pi.low.nrs='dbeta(1,2)'
                                  )
                  )
```

**Run JAGS**

```{r}
# run jags
jagsfit3 <- crosnma.run(model=mod3,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

**Output**

*Table of estimates*

```{r}
knitr::kable(summary(jagsfit3))
```

*Plot of estimates*

```{r}
# to be added
```



## RoB-adjusted model 2

**Set up JAGS model**

The arguments for `method.bias='adjust2'` are similar to the ones that were used above for `method.bias='adjust1'`. However, there are two main differences between them. First, in `'adjust2'`, the relative treatment effects are modeled with a bi-modal normal distribution instead of a univariate normal distribution as in  `'adjust1'` method. Second, we can use a logistic model with a year as a covariate `bias.covariate = c('year','year')` to estimate the probability of bias in `'adjust2'`. In `'adjust1'`, instead we assume  a (${Beta(a,b)}$) to estimate the probability of bias. More details about this method can be found in [@verde_2020] and in Section 2.4.

```{r}
# jags model: code+data
mod4 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ----------
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ----------
                   method.bias='adjust1',
                   bias=c('bias','bias'),
                   bias.type='add',
                   bias.effect='common',
                   bias.covariate = c('year','year'),#
                   #---------- assign a prior ----------
                   prior=list(tau.trt='dunif(0,3)',
                              pi.high.rct='dbeta(5,1)',
                              pi.low.rct='dbeta(1,20)',
                              pi.high.nrs='dbeta(30,1)',
                              pi.low.nrs='dbeta(1,2)'
                   )
)
```

**Run JAGS **

```{r}
# run jags
jagsfit4 <- crosnma.run(model=mod4,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

**Output**

*Table of estimates*

```{r}
knitr::kable(summary(jagsfit4))
```

*Plot of estimates*

```{r}
# to be added
```


# References


