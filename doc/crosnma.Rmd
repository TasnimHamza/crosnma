---
title: "Generic NMA for Dichotomous Outcomes"
author: "Tasnim Hamza"
date: "`r Sys.Date()`"
output: 
  html_vignette:
   toc: true
   toc_depth: 4
   number_sections: true
bibliography: references.bib 
vignette: >
  %\VignetteIndexEntry{crosnma}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(crosnma)
```
# Table of assumptions
We summarize the different assumptions that can be set for the parameters in the model by the following table. More details can be found in Section 2 in [@hamza2021].

| Parameters 	| Assumptions| R-code|  	
|:-------------------|:-----------|:------|
|relative treatment effect ($\delta_{jk}$)| Random-effect model: $\delta_{jk} \sim N(d_{Ak}-d_{Ab}, \tau_\delta^2)$| `trt.effect='random'` |
|   	|Common-effect model: $\delta_{jk}=d_{Ak}-d_{Ab}$| `trt.effect='common'`|
|Covariate effect $\beta_{0, j}$ | Independent effect model: $\beta_{0, j} \sim N(0, 10^2)$| `reg0.effect='independent'` |
|   	|Random-effect model: $\beta_{0,j} \sim N(B_0, \tau_{\beta_0})$| `reg0.effect='random'`|
|Within-study covariate-treatment interaction ($\beta_{1, jk}^W$)| Random-effect model: $\beta_{1, jk}^W \sim N(B_{1, Ak}^W-B_{1, Ab}^W, \tau_{\beta_1^W})$| `regw.effect='random'` |
|   	|Common-effect model: $\beta_{1,jk}^W = B_{1, Ak}^W-B_{1, Ab}^W$| `regw.effect='common'`|
|Between-study covariate-treatment interaction ($\beta_{1, jk}^B$)| Random-effect model: $\beta_{1,jk}^B \sim N(B_{1, Ak}^B-B_{1, Ab}^B, \tau_{\beta_1^B})$| `regb.effect='random'` |
|   	|Common-effect model: $\beta_{1,jk}^B = B_{1, Ak}^B-B_{1, Ab}^B$| `regb.effect='common'`|
|Bias effect ($\gamma_{j}$)| Random-effect model: $\gamma_{j} \sim N(\Gamma, \tau_{\gamma})$| `bias.effect='random'` |
|   	|Common-effect model: $\gamma_{j} = \Gamma$| `bias.effect='common'`|

Here, $i$ refers to participant, $j$ to study and $k$ to treatment. The term $\tau_*$ refers to the heteorgeniety with the subscript ($_*$) to indicate the corresponding paramter. (Explain what is $A$ and $b$)

# Data
We simulate an individual participant data from trials comparing treatments of relapsing remitting multiple sclerosis. The dataset is found in `prt.data`. The aggregate data is available in `std.data`.
The network consists of 4 treatments which has been studied in 6 different studies.The studies are either randomized-controlled trials (RCT) or non-randomized studies (NRS). The data of the NRS study is available on the participant-level. The data of 3 RCT studies are provided on the participant-level and 2 RCTs on the study-level.

```{r}
head(prt.data)
head(std.data)
```

# Explore the network
## Check network connectivity
The network should be checked for its connectivity before running the analysis. If the network is not connected, the model will still run but give the pre-specified prior parameters as estimates.

### Network plot
```{r}
# to be added later
```

## Network characteristics
```{r}
# to be added
```

# The generic NMA/NMR models to combine RCT and NRS
Two steps to run the NMA model. The first step is to create JAGS code and reformat the data that will be used in JAGS code using `crosnma.model()` . In the second step, the output of this function will be used in `crosnma.run()` to run the analysis through JAGS [@plummer_jags]. 

## Naive method

### Set up JAGS model
For the first arguments, the name of the variables need to be set. Then, the `reference` treatment is assigned to drug A. By choosing `trt.effect=random`, we assign a normal distribution to each relative treatment effect across studies. Finally, the different designs; RCT and NRS are combined naively.

```{r}
# jags model: code+data
 mod1 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   trt.effect='random',
                   reference='A',
                   method.bias = 'naive'
                    )
```

### Run JAGS
Next, we fit the NMA model using `crosnma.run()`, where we need to set the number of adaptations, iterations, thinning, burn-ins and chains. 
```{r}
# run jags
jagsfit1 <- crosnma.run(model=mod1,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

### Output
#### Table of estimates
```{r}
knitr::kable(summary(jagsfit1))
```

#### Plot of estimates
```{r}
#plot(jagsfit1)
```

## Using NRS as a prior
In this part, we run a generic NMR model using `sex` and `age` as covariates. We also adjust for NRS bias by use NRS data as a prior information for the RCT likelihood. 

### Set up JAGS model
In addition to model 1 arguments,  four arguments are specified; the first one is to run meta-regression

1. A list of covariate names in prt.data and std.data, respectively, `covariate=list(c('age','sex'),c('age','sex'))`.
1.  We set ` method.bias='prior'`to use NRS as a prior.  
1. This implies that a NMA need to be run with only NRS data which requires us to specify a list of the following arguments: the reference for the NRS data `reference.nrs='D'` and the MCMC settings, the number of adaptations, iterations, burn-ins, thinning and chains. The prior of the relative treatment effect for RCT is set a normal distribution that is either a minimally informative prior `d~dnorm(0, 1e-4)` or the NRS mean and variance for those which are observed in the NRS study.   
```{r}
# jags model: code+data
mod2 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ---------- 
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ---------- 
                   method.bias='prior',
                   run.nrs=list(reference.nrs='D',
                                n.adapt = 10,
                                n.iter=10,
                                n.burnin = 5,
                                thin=1,
                                n.chains=1))
```

### Run JAGS
The MCMC is run under the same set up as in model 1
```{r}
# run jags
jagsfit2 <- crosnma.run(model=mod2,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

### Output
#### Table of estimates
```{r}
knitr::kable(summary(jagsfit2))
```

#### Plot of estimates
```{r}
#plot(jagsfit1)
```


## Adjusting for the study-specific bias - method 1
In this part, we run again a generic NMR model using `sex` and `age` as covariates. But now, the final relative treatment effects are estimated from both NRS and RCT with adjustment to study bias following [@dias_2010]. 
### Set up JAGS model
We provide the bias names `bias=c('bias','bias')` in `prt.data` and `std.data`, respectively. The bias effect is added to the treatment effect so `bias.type='add'`. The  bias effect is set to be equal across studies `bias.effect='common'`. It is optional to give a list of different priors. We set a uniform distribution to the common heterogeneity of the treatment effect across studies, `tau.trt='dunif(0,3)'`. We also set beta distribution (\eqn{Beta(a,b)}) as priors for the probability of bias. This is categorized into high bias RCT `pi.high.rct='dbeta(5,1)'`, low bias RCT `pi.low.rct='dbeta(1,20)'`,high bias NRS `pi.high.nrs='dbeta(30,1)'` and low bias NRS `pi.low.nrs='dbeta(1,2)'`.  The ratio \eqn{a/b} controls the skewness of the beta distribution where when the ratio goes further beyond 1, the mean is located closer to 1 and vice versa. 
```{r}
# jags model: code+data
mod3 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ---------- 
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ---------- 
                   method.bias='adjust1',
                   bias=c('bias','bias'), 
                   bias.type='add',
                   bias.effect='common',
                   #---------- assign a prior ---------- 
                   prior=list(tau.trt='dunif(0,3)',
                              pi.high.rct='dbeta(5,1)',
                              pi.low.rct='dbeta(1,20)',
                              pi.high.nrs='dbeta(30,1)',
                              pi.low.nrs='dbeta(1,2)'
                                  )
                  )
```

### Run JAGS

```{r}
# run jags
jagsfit3 <- crosnma.run(model=mod3,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

### Output
#### Table of estimates
```{r}
knitr::kable(summary(jagsfit3))
```

#### Plot of estimates
```{r}
#plot(jagsfit1)
```


## Adjusting for the study-specific bias - method 2

### Set up JAGS model
The arguments for `method.bias='adjust2'` are similar to the ones that were used above for `method.bias='adjust1'`. There are two differences between them. First, in this case, the relative treatment effects are modeled with a bi-modal normal distribution instead of a univariate normal distribution as in  `'adjust1'` method. Second, in `'adjust2'`, we use a logistic model with a year as a covariate `bias.covariate = c('year','year')` to estimate the probability of bias. More details can be found [@verde_2020]

```{r}
# jags model: code+data
mod4 <- crosnma.model(prt.data=prt.data,
                   std.data=std.data,
                   trt=c('trt','trt'),
                   study=c('study','study'),
                   outcome=c('outcome','outcome'),
                   n='n',
                   design=c('design','design'),
                   reference='A',
                   trt.effect='random',
                   #----------  meta-regression ----------
                   covariate = list(c('age','sex'),c('age','sex')),
                   #---------- bias adjustment ----------
                   method.bias='adjust1',
                   bias=c('bias','bias'),
                   bias.type='add',
                   bias.effect='common',
                   bias.covariate = c('year','year'),#
                   #---------- assign a prior ----------
                   prior=list(tau.trt='dunif(0,3)',
                              pi.high.rct='dbeta(5,1)',
                              pi.low.rct='dbeta(1,20)',
                              pi.high.nrs='dbeta(30,1)',
                              pi.low.nrs='dbeta(1,2)'
                   )
)
```

### Run JAGS 

```{r}
# run jags
jagsfit4 <- crosnma.run(model=mod4,
              n.adapt = 20,
              n.iter=50,
              thin=1,
              n.chains=3)
```

### Output
#### Table of estimates
```{r}
knitr::kable(summary(jagsfit4))
```

#### Plot of estimates
```{r}
#plot(jagsfit1)
```


# References


